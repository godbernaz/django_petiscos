{% extends 'base.html' %}
{% load loja_filters %}
{% load static %}

<!-- Header Title -->
{% block page_title %}
<h1 class="custom-header-title">{{ product.name }}</h1>
{% endblock %}

{% block content %}
<div class="custom-pattern py-5">
    <!-- Cartão Superior -->
    <div class="cartao-produto">
        <div class="cartao-corpo-produto">
            <h2 class="titulo-produto">{{ product.name }}</h2>

            {% if product.is_sale %}
                <div class="precos-produto">
                    <span id="preco-atual" class="preco-promocao-produto">{{ product.sale_price }}€</span>
                    <strike class="preco-original-produto">{{ product.price }}€</strike>
                </div>
                <input type="hidden" id="preco-unitario" value="{{ product.sale_price }}">
            {% else %}
                <div class="precos-produto">
                    <span id="preco-atual" class="preco-final-produto">{{ product.price }}€</span>
                </div>
                <input type="hidden" id="preco-unitario" value="{{ product.price }}">
            {% endif %}
            <div class="acoes-produto">
                <!-- Seletor de Quantidade -->
                <div class="qnt-number-control">
                    <div class="qnt-number-left" id="decrease-qty" data-content="-"></div>
                    <input type="number" name="number" id="quantidade-prod" class="qnt-number-quantity" value="1" readonly>
                    <div class="qnt-number-right" id="increase-qty" data-content="+"></div>
                </div>
                <!-- Botões de Ação -->
                <div class="botoes-acoes">
                    <a href="{% url 'home' %}" class="botaoprod-voltar">VOLTAR</a>
                    <button type="button" value="{{ product.id }}" class="botaoprod-adicionar" id="add-cart-ap">
                        ADICIONAR <i class="bi bi-basket"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cartão Inferior -->
    <div class="cartao-detalhes-produto">
        <ul class="tabs-produto">
            <li class="tab-item active" data-tab="detalhes">Detalhes do Produto</li>
            <li class="tab-item" data-tab="avaliacoes">Avaliações</li>
        </ul>
        <div class="tab-content active" id="detalhes">
            <p>{{ product.description }}</p>
        </div>
        <div class="tab-content" id="avaliacoes">
            <center><h3>Avaliações dos clientes</h3></center>

            <!-- Média de Avaliações -->
            <div class="average-rating">
                <div class="stars">
                    {{ average_rating|render_stars|safe }}
                </div>
                <p class="rating-summary">{{ average_rating }} de 5</p>
                <small class="total-reviews">{{ total_reviews }} avaliações no total</small>
            </div>

            <!-- Linha de Separação -->
            <hr class="separator-line">
            
            {% if reviews %}
                <hr class="separator-line">
                <h4>Comentários:</h4>
                <div class="reviews-list">
                    {% for review in reviews %}
                        <div class="review-item">
                            <strong>{{ review.user.username }}</strong> - 
                            <span>{{ review.rating }} estrelas</span> - 
                            <span class="review-date">{{ review.created_at|date:"m/d/Y" }}</span>
                            <p class="review-comment">
                                <span class="review-text">{{ review.comment|slice:":200" }}</span>
                                {% if review.comment|length > 200 %}
                                    <span class="review-text-full" style="display: none;">{{ review.comment }}</span>
                                    <button class="toggle-text-btn">Ler mais</button>
                                {% endif %}
                            </p>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p>Ainda não há avaliações para este produto.</p>
            {% endif %}

            <hr class="separator-line">
            <!-- Formulário para Avaliação -->
            {% if user.is_authenticated %}
                <h4>Deixe a sua avaliação</h4>
                <form method="POST">
                    {% csrf_token %}
                    <div class="rating">
                        <input type="radio" id="star5" name="rating" value="5">
                        <label for="star5" title="5 estrelas">★</label>

                        <input type="radio" id="star4" name="rating" value="4">
                        <label for="star4" title="4 estrelas">★</label>

                        <input type="radio" id="star3" name="rating" value="3">
                        <label for="star3" title="3 estrelas">★</label>

                        <input type="radio" id="star2" name="rating" value="2">
                        <label for="star2" title="2 estrelas">★</label>

                        <input type="radio" id="star1" name="rating" value="1">
                        <label for="star1" title="1 estrela">★</label>
                    </div>
                    <textarea name="comment" class="form-control mt-3" rows="4" placeholder="Deixe seu comentário aqui..."></textarea>
                    <button type="submit" class="btn btn-primary mt-3">Submeter Avaliação</button>
                </form>
            {% else %}
                <p><a href="{% url 'login' %}">Faça login</a> para deixar a sua avaliação.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
    // Atualiza o preço total com base na quantidade
    function atualizarPrecoTotal() {
        const precoUnitario = parseFloat(document.getElementById('preco-unitario').value);
        const quantidade = parseInt(document.getElementById('quantidade-prod').value);
        const precoTotal = (precoUnitario * quantidade).toFixed(2);
        document.getElementById('preco-atual').textContent = `${precoTotal}€`;
    }

    // Função para aumentar a quantidade
    document.getElementById('increase-qty').addEventListener('click', function () {
        const qty = document.getElementById('quantidade-prod');
        qty.value = parseInt(qty.value) + 1;
        atualizarPrecoTotal();
    });

    // Função para diminuir a quantidade
    document.getElementById('decrease-qty').addEventListener('click', function () {
        const qty = document.getElementById('quantidade-prod');
        if (parseInt(qty.value) > 1) {
            qty.value = parseInt(qty.value) - 1;
            atualizarPrecoTotal();
        }
    });

    // Tabs Interativas
    document.querySelectorAll('.tab-item').forEach(tab => {
        tab.addEventListener('click', function () {
            document.querySelectorAll('.tab-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            this.classList.add('active');
            document.getElementById(this.dataset.tab).classList.add('active');
        });
    });

    // Adicionar ao carrinho via AJAX
    $(document).on('click', '#add-cart-ap', function(e) {
        e.preventDefault();
        $.ajax({
            type: 'POST',
            url: '{% url "cart_add" %}',
            data: {
                product_id: $('#add-cart-ap').val(),
                product_qty: $('#quantidade-prod').val(),
                csrfmiddlewaretoken: '{{ csrf_token }}',
                action: 'post'
            },
            success: function(json) {
                document.getElementById("cart_quantity").textContent = json.qty;
                location.reload();
            },
            error: function(xhr, errmsg, err) {
                console.error("Erro ao adicionar ao carrinho:", errmsg);
            }
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        const toggleButtons = document.querySelectorAll(".toggle-text-btn");

        toggleButtons.forEach((button) => {
            button.addEventListener("click", function () {
                const reviewItem = this.closest(".review-item");
                const fullText = reviewItem.querySelector(".review-text-full");
                const truncatedText = reviewItem.querySelector(".review-text");

                if (fullText.style.display === "none") {
                    fullText.style.display = "inline";
                    truncatedText.style.display = "none";
                    this.textContent = "Ler menos";
                } else {
                    fullText.style.display = "none";
                    truncatedText.style.display = "inline";
                    this.textContent = "Ler mais";
                }
            });
        });
    });
</script>
{% endblock %}